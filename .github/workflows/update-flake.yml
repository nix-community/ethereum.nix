name: Update Flake

on:
  workflow_call:
    inputs:
      packages:
        description: "Space-separated list of specific packages to update (empty for all)"
        required: false
        type: string
        default: ""
      inputs:
        description: "Space-separated list of specific inputs to update (empty for all)"
        required: false
        type: string
        default: ""
      pr-labels:
        description: "Comma-separated list of labels to add to PRs"
        required: false
        type: string
        default: "dependencies,automated"
      auto-merge:
        description: "Enable auto-merge for created pull requests"
        required: false
        type: boolean
        default: false
    secrets:
      APP_ID:
        description: "GitHub App ID"
        required: true
      APP_PRIVATE_KEY:
        description: "GitHub App private key"
        required: true

jobs:
  discover:
    runs-on: ubuntu-slim
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      has-updates: ${{ steps.build-matrix.outputs.has-updates }}
    steps:
      - uses: actions/checkout@v6
      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ steps.app-token.outputs.token }}
          extra_nix_config: |
            extra-substituters = https://nix-community.cachix.org
            extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
      - name: Build update matrix
        id: build-matrix
        env:
          PACKAGES: "${{ inputs.packages }}"
          INPUTS: "${{ inputs.inputs }}"
        run: python3 .github/actions/discovery.py

  update:
    needs: discover
    if: needs.discover.outputs.has-updates == 'true'
    runs-on: ubuntu-slim
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ steps.app-token.outputs.token }}
          extra_nix_config: |
            extra-substituters = https://nix-community.cachix.org
            extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
      - name: Set up git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Perform update
        id: update
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Use the update script
          if [[ "${{ matrix.type }}" = package ]]; then
            # Only load the devshell to update packages
            nix develop .#ci -c .github/actions/update.sh "${{ matrix.type }}" "${{ matrix.name }}"
          else
            .github/actions/update.sh "${{ matrix.type }}" "${{ matrix.name }}"
          fi
      - name: Create pull request
        if: steps.update.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_LABELS: ${{ inputs.pr-labels }}
          AUTO_MERGE: ${{ inputs.auto-merge }}
        run: |
          .github/actions/create-pr.sh \
            "${{ matrix.type }}" \
            "${{ matrix.name }}" \
            "${{ matrix.current_version }}" \
            "${{ steps.update.outputs.new_version }}"

  update-readme:
    needs: [discover, update]
    runs-on: ubuntu-slim
    if: always() && needs.discover.outputs.has-updates == 'true'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: main
      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            extra-substituters = https://nix-community.cachix.org
            extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
      - name: Set up git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Regenerate README
        run: ./scripts/generate-package-docs.py
      - name: Create pull request
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          if git diff --quiet README.md; then
            echo "No README changes"
            exit 0
          fi
          branch="update/readme"
          # Check if branch exists remotely and delete it
          if git ls-remote --exit-code --heads origin "$branch" >/dev/null 2>&1; then
            git push origin --delete "$branch" || true
          fi
          git checkout -b "$branch"
          git add README.md
          git commit -m "README: regenerate package documentation"
          git push -u origin "$branch"
          gh pr create \
            --title "README: regenerate package documentation" \
            --body "Automated README regeneration after package updates." \
            --label "documentation,automated"

  summary:
    needs: [discover, update, update-readme]
    runs-on: ubuntu-slim
    if: always() && needs.discover.outputs.has-updates == 'true'
    steps:
      - name: Generate summary
        run: |-
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check overall status
          if [ "${{ contains(needs.update.result, 'failure') }}" = "true" ]; then
            echo "⚠️ Some updates failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ All update jobs completed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-merge: ${{ inputs.auto-merge }}" >> $GITHUB_STEP_SUMMARY
